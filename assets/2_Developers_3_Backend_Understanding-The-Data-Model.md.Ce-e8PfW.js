import{_ as t,c as a,o,ag as r}from"./chunks/framework.BRQrZDXk.js";const p=JSON.parse('{"title":"Infogami Database Schema","description":"","frontmatter":{},"headers":[],"relativePath":"2_Developers/3_Backend/Understanding-The-Data-Model.md","filePath":"2_Developers/3_Backend/Understanding-The-Data-Model.md"}'),n={name:"2_Developers/3_Backend/Understanding-The-Data-Model.md"};function s(i,e,d,h,l,c){return o(),a("div",null,e[0]||(e[0]=[r('<h2 id="adding-new-tables" tabindex="-1">Adding new Tables <a class="header-anchor" href="#adding-new-tables" aria-label="Permalink to &quot;Adding new Tables&quot;">​</a></h2><p>Interested in adding new table to our schema? Check out this reference PR: <a href="https://github.com/internetarchive/openlibrary/pull/7928/files" target="_blank" rel="noreferrer">https://github.com/internetarchive/openlibrary/pull/7928/files</a></p><h2 id="querying-for-data" tabindex="-1">Querying for Data <a class="header-anchor" href="#querying-for-data" aria-label="Permalink to &quot;Querying for Data&quot;">​</a></h2><p>The <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/bookshelves.py#L78-L90" target="_blank" rel="noreferrer"><code>bookshelves</code></a> core model shows us how we can use a database connection on the backend to query for data</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>from openlibrary.core import db</span></span>\n<span class="line"><span>oldb = db.get_db() # i.e. web.database(**web.config.db_parameters)</span></span>\n<span class="line"><span>query = &quot;SELECT count(*) from bookshelves_books&quot;</span></span>\n<span class="line"><span>oldb.query(query)</span></span></code></pre></div><h3 id="fetching-things-individually-or-in-bulk" tabindex="-1">Fetching Things Individually or in Bulk <a class="header-anchor" href="#fetching-things-individually-or-in-bulk" aria-label="Permalink to &quot;Fetching Things Individually or in Bulk&quot;">​</a></h3><p>From within routers/controllers, it&#39;s much more common to use the <code>web.ctx.site</code> object to fetch individual or multiple records.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>doc = web.ctx.site.get(&quot;/works/OL5285479W&quot;)</span></span>\n<span class="line"><span>keys = [&quot;/works/OL5285479W&quot;, &quot;/works/OL257943W&quot;, &quot;/works/OL27448W&quot;]</span></span>\n<span class="line"><span>docs = web.ctx.site.get_many(keys)</span></span></code></pre></div><h2 id="understanding-infogami-infobase-and-web-py" tabindex="-1">Understanding Infogami, Infobase, and Web.py <a class="header-anchor" href="#understanding-infogami-infobase-and-web-py" aria-label="Permalink to &quot;Understanding Infogami, Infobase, and Web.py&quot;">​</a></h2><p>Open Library is built using a wiki engine called <a href="https://openlibrary.org/dev/docs/infogami" target="_blank" rel="noreferrer">infogami</a> which sits on top of the <code>web.py</code> python micro-web framework (comparable to flask). Web.py uses a variable called <code>web.ctx</code> to maintain the context of the application during/across a http request. Web.py also maintains a postgres database connection using <code>web.db</code>. Infogami extends and wraps the <code>web.db</code> controller by offering a system called <code>infobase</code> which behaves like an ORM (db wrapper) to allow us to define arbitrary data types like works, editions, authors, etc.</p><p>At the simplest level, Infobase works by relying on 2 tables: <code>things</code> and <code>data</code>:</p><ul><li><code>things</code> gives every object in our system and ID, a type, and a reference to its data in the data table.</li><li><code>data</code> is just a massive catalog of json data that can be references by querying and joining things</li></ul><p>Infogami injects a utility called <code>site</code> into web.py&#39;s <code>web.ctx</code> (<a href="https://webpy.org/cookbook/ctx" target="_blank" rel="noreferrer">https://webpy.org/cookbook/ctx</a>) variable (ctx maintains information and connections specific to the current client). The <code>web.ctx.site</code> utility handles queries and joins for you so you can request and key from the things table, fetch all its corresponding data, and also leverage and models and functions we have defined for that thing&#39;s type.</p><h1 id="infogami-database-schema" tabindex="-1">Infogami Database Schema <a class="header-anchor" href="#infogami-database-schema" aria-label="Permalink to &quot;Infogami Database Schema&quot;">​</a></h1><p>Every Infogami page on Open Library (i.e. something with a URL) has an associated type. Each type contains a schema that states what fields can be used with it and what format those fields are in. Those are used to generate view and edit templates which can then be further customized as a particular type requires. Infogami provides a generic way through it&#39;s wiki to create new types as needed.</p><p>Aside from the tables listed <a href="#open-library-feature-tables">here</a>, Open Library in essence only really has <strong>only two database tables</strong>. By default they will have the same pretty basic functionality through Infogami</p><h3 id="thing-table" tabindex="-1">Thing table <a class="header-anchor" href="#thing-table" aria-label="Permalink to &quot;Thing table&quot;">​</a></h3><p>The thing table defines <a href="https://openlibrary.org/dev/docs/infogami#anchor5" target="_blank" rel="noreferrer">types</a> like editions, works authors, users, languages. The thing table also keeps track of instances of things by their identifiers it basically registers their IDs in the table as an instance.</p><p>Entries in a sample thing table</p><table tabindex="0"><thead><tr><th>id</th><th>key</th><th>type</th><th>latest_revision</th><th>created</th><th>last_modified</th></tr></thead><tbody><tr><td>2</td><td>/type/key</td><td>1</td><td>1</td><td>2013-03-20 10:27:01.322813</td><td>2013-03-20 10:27:01.322813</td></tr><tr><td>3</td><td>/type/string</td><td>1</td><td>1</td><td>2013-03-20 10:27:01.322813</td><td>2013-03-20 10:27:01.322813</td></tr><tr><td>4</td><td>/type/text</td><td>1</td><td>1</td><td>2013-03-20 10:27:01.322813</td><td>2013-03-20 10:27:01.322813</td></tr><tr><td>5</td><td>/type/int</td><td>1</td><td>1</td><td>2013-03-20 10:27:01.322813</td><td>2013-03-20 10:27:01.322813</td></tr></tbody></table><h3 id="data-table" tabindex="-1">Data table <a class="header-anchor" href="#data-table" aria-label="Permalink to &quot;Data table&quot;">​</a></h3><p>The data table on the other hand maps one of these types to all of the data associated with it Infogami provides a generic way through it&#39;s wiki to create new types as are needed</p><p>Entry in a sample data table</p><table tabindex="0"><thead><tr><th>thing_id</th><th>revision</th><th>data</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>{&quot;created&quot;: {&quot;type&quot;: &quot;/type/datetime&quot;, &quot;value&quot;: &quot;2013-03-20T10:27:01.223351&quot;}, &quot;last_modified&quot;: {&quot;type&quot;: &quot;/type/datetime&quot;, &quot; value&quot;: &quot;2013-03-20T10:27:01.223351&quot;}, &quot;latest_revision&quot;: 1, &quot;key&quot;: &quot;/type/type&quot;, &quot;type&quot;: {&quot;key&quot;: &quot;/type/type&quot;}, &quot;id&quot;: 1, &quot;revision&quot;: 1}</td></tr></tbody></table><p>Read further about Infogami and type on: <a href="https://openlibrary.org/dev/docs/infogami" target="_blank" rel="noreferrer">https://openlibrary.org/dev/docs/infogami</a></p><h1 id="open-library-feature-tables" tabindex="-1">Open Library Feature Tables <a class="header-anchor" href="#open-library-feature-tables" aria-label="Permalink to &quot;Open Library Feature Tables&quot;">​</a></h1><p>Open Library has a number of additional tables that are used to support a variety of features. The DDL for these tables can be found <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/schema.sql" target="_blank" rel="noreferrer">here</a>.</p><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/9542a554-8d6c-4d78-ad7d-c41845ec9af8" alt="Screenshot from 2023-12-14 11-19-48"></p><h2 id="bookshelves-and-bookshelves-books" tabindex="-1"><code>bookshelves</code> and <code>bookshelves_books</code> <a class="header-anchor" href="#bookshelves-and-bookshelves-books" aria-label="Permalink to &quot;`bookshelves` and `bookshelves_books`&quot;">​</a></h2><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/2c9f654a-d926-4faf-9db0-499fcc0bf6ae" alt="Screenshot from 2023-12-14 11-20-02"></p><p>These tables are used to store the books that patrons have on their &quot;Want to Read&quot;, &quot;Currently Reading&quot;, and &quot;Already Read&quot; reading log shelves. The <code>bookshelves_books</code> table holds most of this data, with <code>bookshelves</code> acting as a look-up table for shelf names.</p><p><a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/bookshelves.py" target="_blank" rel="noreferrer"><code>bookshelves.py</code></a> provides functions which interact with the reading log tables.</p><h2 id="yearly-reading-goals" tabindex="-1"><code>yearly_reading_goals</code> <a class="header-anchor" href="#yearly-reading-goals" aria-label="Permalink to &quot;`yearly_reading_goals`&quot;">​</a></h2><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/51a29f03-25fd-4286-8423-23ae3c8dba1d" alt="yearly_reading_goals"></p><p>This table stores the <code>target</code> number of books that a patron commits to reading in a given year. Functions which interact with the <code>yearly_reading_goals</code> table can be found in <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/yearly_reading_goals.py" target="_blank" rel="noreferrer"><code>yearly_reading_goals.py</code></a>.</p><h2 id="bookshelves-events" tabindex="-1"><code>bookshelves_events</code> <a class="header-anchor" href="#bookshelves-events" aria-label="Permalink to &quot;`bookshelves_events`&quot;">​</a></h2><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/38fdd1e8-07ce-445b-9ca8-2621b54e00e3" alt="check_ins"></p><p>A patron can track the last date that they have finished any book that is on their &quot;Already Read&quot; shelf. The <code>bookshelves_events</code> table stores these dates, and may later be used to store other dates that a patron may want to track (date they started reading the book, start and finish dates of other times that they have read a book, etc.).</p><p>Related code can be found in <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/bookshelves_events.py" target="_blank" rel="noreferrer"><code>bookshelves_events.py</code></a>.</p><h2 id="observations" tabindex="-1"><code>observations</code> <a class="header-anchor" href="#observations" aria-label="Permalink to &quot;`observations`&quot;">​</a></h2><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/8a1fcfb1-30df-4f58-99f3-a0efb757b09a" alt="observations"></p><p>Patron&#39;s can give structured reviews of books by attaching any number of pre-defined tags to a work. These are stored in the <code>observations</code> table.</p><p>The code that interacts with this table, as well as the definitions for the tags, are found in <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/observations.py" target="_blank" rel="noreferrer"><code>observations.py</code></a>.</p><h2 id="booknotes" tabindex="-1"><code>booknotes</code> <a class="header-anchor" href="#booknotes" aria-label="Permalink to &quot;`booknotes`&quot;">​</a></h2><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/41986736-6fdc-4bb6-9bbf-1544fa4ff60e" alt="booknotes"></p><p>A patron can add private notes that only they can read to any work. The <code>booknotes</code> table stores these notes. <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/booknotes.py" target="_blank" rel="noreferrer"><code>booknotes.py</code></a> contains the code that interacts with this table.</p><h2 id="ratings" tabindex="-1"><code>ratings</code> <a class="header-anchor" href="#ratings" aria-label="Permalink to &quot;`ratings`&quot;">​</a></h2><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/9f9f000c-9cdc-4aa7-a022-bd4c1855266b" alt="ratings"></p><p>Patrons can submit a star rating for a work. The <code>ratings</code> table holds these star ratings. Consult <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/ratings.py" target="_blank" rel="noreferrer"><code>ratings.py</code></a> for related code.</p><h2 id="community-edits-queue" tabindex="-1"><code>community_edits_queue</code> <a class="header-anchor" href="#community-edits-queue" aria-label="Permalink to &quot;`community_edits_queue`&quot;">​</a></h2><p><img src="https://github.com/internetarchive/openlibrary/assets/28732543/9dc1c072-176d-4f54-96b4-3b2ea582a744" alt="merge_queue"></p><p>This table holds librarian requests, which in turn are used to populate the librarian request table at <a href="https://openlibrary.org/merges" target="_blank" rel="noreferrer">https://openlibrary.org/merges</a>. Code which interacts directly with thus table can be found in <a href="https://github.com/internetarchive/openlibrary/blob/master/openlibrary/core/edits.py" target="_blank" rel="noreferrer"><code>edits.py</code></a>.</p>',52)]))}const u=t(n,[["render",s]]);export{p as __pageData,u as default};
