import{_ as t,c as o,o as i,ag as n}from"./chunks/framework.BRQrZDXk.js";const u=JSON.parse('{"title":"Running Tests, Writing Testing, & Continuous Integration","description":"","frontmatter":{},"headers":[],"relativePath":"2_Developers/misc/Testing.md","filePath":"2_Developers/misc/Testing.md"}'),a={name:"2_Developers/misc/Testing.md"};function r(s,e,l,c,d,h){return i(),o("div",null,e[0]||(e[0]=[n(`<h1 id="running-tests-writing-testing-continuous-integration" tabindex="-1">Running Tests, Writing Testing, &amp; Continuous Integration <a class="header-anchor" href="#running-tests-writing-testing-continuous-integration" aria-label="Permalink to &quot;Running Tests, Writing Testing, &amp; Continuous Integration&quot;">​</a></h1><p>XXX This page needs updating</p><h2 id="running-automated-tests" tabindex="-1">Running Automated Tests <a class="header-anchor" href="#running-automated-tests" aria-label="Permalink to &quot;Running Automated Tests&quot;">​</a></h2><p>From the root of your local openlibrary project, you can run the JavaScript and Python unit tests in a Docker container with the following command:</p><p><code>docker compose run --rm home make test</code></p><p>To run the pytests in one or more files, you can use:</p><pre><code>docker compose run --rm home pytest openlibrary/plugins/importapi/tests/test_import_validator.py
</code></pre><p>General Docker instructions are to be found in the repo at <a href="https://github.com/internetarchive/openlibrary/tree/master/docker" target="_blank" rel="noreferrer">https://github.com/internetarchive/openlibrary/tree/master/docker</a> and repo testing instructions are in the main README: <a href="https://github.com/internetarchive/openlibrary/blob/master/Readme.md#running-tests" target="_blank" rel="noreferrer">https://github.com/internetarchive/openlibrary/blob/master/Readme.md#running-tests</a></p><p>To run the same tests on the shared development server, <code>ol-dev0</code> (requires ssh access), make sure you activate venv:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ssh -A ol-dev0</span></span>
<span class="line"><span>source /opt/openlibrary/venv/bin/activate </span></span>
<span class="line"><span>cd /opt/openlibrary/openlibrary</span></span>
<span class="line"><span>sudo make test</span></span></code></pre></div><h2 id="linting" tabindex="-1">Linting <a class="header-anchor" href="#linting" aria-label="Permalink to &quot;Linting&quot;">​</a></h2><p>The Continuous Integration (CI) server will <a href="https://en.wikipedia.org/wiki/Lint_(software)" target="_blank" rel="noreferrer">lint</a> (i.e. statically analyze code for bugs and stylistic bugs) the code in each Pull Request (PR) and attempt to fix any errors it finds. However, for errors that require human intervention, you may see something similar to the following:</p><p><img src="https://github.com/internetarchive/openlibrary/assets/26524678/20fec6e1-20eb-4a40-9744-83762e25777a" alt="image"></p><p>Although you can simply look at the details, change your code and resubmit to see if everything passes, you can also pre-lint Python and JavaScript files locally to avoid repeated re-submits to the CI server.</p><h3 id="lint-javascript-in-docker" tabindex="-1">Lint JavaScript in Docker <a class="header-anchor" href="#lint-javascript-in-docker" aria-label="Permalink to &quot;Lint JavaScript in Docker&quot;">​</a></h3><p>To lint only JS, one can run:</p><ul><li><code>docker compose run --rm home npm run lint</code>.</li></ul><h3 id="lint-everything-with-pre-commit-from-your-shell-outside-of-docker" tabindex="-1">Lint everything with <code>pre-commit</code> from your shell outside of Docker <a class="header-anchor" href="#lint-everything-with-pre-commit-from-your-shell-outside-of-docker" aria-label="Permalink to &quot;Lint everything with \`pre-commit\` from your shell outside of Docker&quot;">​</a></h3><p>To lint everything the CI server checks (JavaScript, <code>mypy</code>, <code>black</code>, <code>ruff</code>, etc.), and to do so automatically at the time of commit, one can run, in the local environment, outside of Docker, a Python program named <code>pre-commit</code>. This will use <code>git</code>&#39;s <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks" target="_blank" rel="noreferrer">hooks</a> to run Open Library-specific linting checks when committing code in <code>git</code>. Because <code>pre-commit</code> integrates with <code>git</code>, that means it runs outside of Docker, and needs to be available to <code>git</code> in your current environment.</p><p>Prerequisites:</p><ul><li>the version of your current Python interpreter must match the version of Python specified in the <code>default_language_version</code> section of <a href="https://github.com/internetarchive/openlibrary/blob/master/.pre-commit-config.yaml" target="_blank" rel="noreferrer"><code>.pre-commit-config.yaml</code></a>.</li></ul><p>Although a complete discussion of managing Python&#39;s versions and Python&#39;s virtual environments is outside the scope of this discussion, it is likely worth creating a virtual environment for each Python project on which you work. See Python&#39;s own documentation about <a href="https://docs.python.org/3/library/venv.html" target="_blank" rel="noreferrer"><code>venv</code></a> for one such approach to managing virtual environments. Additionally, if your <code>python3 --version</code> doesn&#39;t match the version specified in <code>.pre-commit-config.yaml</code>, consider <a href="https://github.com/pyenv/pyenv" target="_blank" rel="noreferrer"><code>pyenv</code></a> on Linux, macOS, or Windows Subsystem for Linux, or <a href="https://github.com/pyenv-win/pyenv-win" target="_blank" rel="noreferrer"><code>pyenv-win</code></a> on Windows outside of the Windows Subsystem for Linux.</p><p><em>Note:</em> this will install a <code>git</code> commit hook that will run prior to every commit. As there are times where one may simply wish to commit code, even if it will fail the linting, <strong>one can override commit hooks with <code>git commit --no-verify</code></strong>. For more on <code>pre-commit</code>, see <a href="https://pre-commit.com/" target="_blank" rel="noreferrer">https://pre-commit.com/</a>.</p><p>To enable <code>pre-commit</code>, run the following in your local shell outside of Docker:</p><ol><li><code>pip install pre-commit</code> or <code>brew install pre-commit</code>; and</li><li><code>pre-commit install</code></li></ol><p>Henceforth, <code>pre-commit</code> will lint your code with every <code>git commit</code> (unless you commit with <code>git commit --no-verify</code> to disable running the hooks). To manually run <code>pre-commit</code>, you can execute <code>pre-commit run --all-files</code>.</p><p>If you see an error similar to either of the following, please ensure you the version of you Python interpreter matches the version specified in <code>.pre-commit-config.yaml</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>An unexpected error has occurred: CalledProcessError: command: (&#39;/home/scott/.pyenv/versions/3.9/bin/python3.9&#39;, &#39;-mvirtualenv&#39;, &#39;/home/scott/.cache/pre-commit/repolh5wc3hy/py_env-python3.11&#39;, &#39;-p&#39;, &#39;python3.11&#39;)</span></span>
<span class="line"><span>return code: 1</span></span>
<span class="line"><span>stdout:</span></span>
<span class="line"><span>    RuntimeError: failed to find interpreter for Builtin discover of python_spec=&#39;python3.11&#39;</span></span>
<span class="line"><span>stderr: (none)</span></span>
<span class="line"><span>Check the log at /home/scott/.cache/pre-commit/pre-commit.log</span></span></code></pre></div><p>To remove <code>pre-commit</code>, run <code>pre-commit uninstall</code>.</p><h1 id="testing-critical-paths" tabindex="-1">Testing Critical Paths <a class="header-anchor" href="#testing-critical-paths" aria-label="Permalink to &quot;Testing Critical Paths&quot;">​</a></h1><h2 id="main-components-actions" tabindex="-1">Main Components / Actions <a class="header-anchor" href="#main-components-actions" aria-label="Permalink to &quot;Main Components / Actions&quot;">​</a></h2><ul><li>Auth (registration, signup)</li><li>Lending (Borrow, Return, Join/Leave Waitlist)</li><li>Searching (all, title, author, advanced, subject)</li><li>Navigation (header, footer)</li><li>Accounts (Settings)</li><li>Books (editions/works pages, share links, etc)</li><li>Carousels (subject, IA-query-based)</li><li>Reading Log (setting status, changing set status, removing status)</li><li>Lists (add, remove, create, delete)</li><li>Edits? (add fake book, history, merges?)</li><li>Import</li><li>Stats</li></ul><h3 id="auth" tabindex="-1">Auth <a class="header-anchor" href="#auth" aria-label="Permalink to &quot;Auth&quot;">​</a></h3><ul><li>User can register for an account</li><li>User can login to IA and OL with Archive.org credentials</li></ul><h3 id="lending" tabindex="-1">Lending <a class="header-anchor" href="#lending" aria-label="Permalink to &quot;Lending&quot;">​</a></h3><ul><li>User can read a public domain book</li><li>User can borrow an inlibrary book</li><li>User can read a borrowed inlibrary book</li><li>User can return a borrowed inlibrary book</li><li>User can join waitlist</li><li>User can leave waitlist</li></ul><h3 id="searching" tabindex="-1">Searching <a class="header-anchor" href="#searching" aria-label="Permalink to &quot;Searching&quot;">​</a></h3><ul><li>Search by &quot;All&quot;</li><li>Search by &quot;Title&quot;</li><li>Search by &quot;Author&quot;</li><li>Search by &quot;Subject&quot;</li><li>Search by &quot;Advanced&quot; (form)</li><li>Switch modes: Everything, Ebooks-only, Print-disabled</li><li>Test facets</li></ul><h3 id="navigation" tabindex="-1">Navigation <a class="header-anchor" href="#navigation" aria-label="Permalink to &quot;Navigation&quot;">​</a></h3><ul><li>Test dropdowns</li><li>Click each link and verify the destination pages match expectations</li></ul><h3 id="reading-log" tabindex="-1">Reading Log <a class="header-anchor" href="#reading-log" aria-label="Permalink to &quot;Reading Log&quot;">​</a></h3><p><em>On Book/Works Pages</em></p><ul><li>From clean slate, mark as &quot;Want to Read&quot;, &quot;Currently Reading&quot;, &quot;Already Read&quot;</li><li>From &quot;Want to Read&quot;, &quot;Currently Reading&quot;, &quot;Already Read&quot;; change state</li><li>From &quot;Want to Read&quot;, &quot;Currently Reading&quot;, &quot;Already Read&quot;; remove state</li></ul><h1 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h1><p><strong>Question:</strong> GitHub Actions CI build fails due to JavaScript linting errors?</p><p><strong>Answer:</strong> This can be solved by running <code>npm run lint:fix</code> inside the docker container.</p><p><strong>Issue link:</strong> For a full description see: <a href="https://github.com/internetarchive/openlibrary/issues/1868" target="_blank" rel="noreferrer">https://github.com/internetarchive/openlibrary/issues/1868</a></p><hr><p><strong>Question:</strong> What should I do if I come across a bundle-size error (like the one below) while running <code>docker compose run --rm home make test</code> to test?</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span> FAIL static/build/page-plain.css: 18.81KB &gt; maxSize 18.8KB (gzip)</span></span></code></pre></div><p><strong>Answer:</strong> Unless the extra CSS content is well justified, consider placing styles in an JavaScript entry point file e.g. <code>&lt;file_name&gt;--js.less</code> and load it inside <code>static/css/js-all.less</code> via <code>@import</code>. This CSS will only get loaded via JavaScript and has a much higher bundle size threshold, otherwise, bundle-sizes can be changed in <code>openlibrary/package.json</code>.</p><p><strong>Issue Link</strong>: <a href="https://github.com/internetarchive/openlibrary/wiki/Frontend-Guide#beware-of-bundle-sizes" target="_blank" rel="noreferrer">https://github.com/internetarchive/openlibrary/wiki/Frontend-Guide#beware-of-bundle-sizes</a></p>`,52)]))}const m=t(a,[["render",r]]);export{u as __pageData,m as default};
