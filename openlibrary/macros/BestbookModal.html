$def with (work, link_markup, id, classes='', reload_id=None, edition_key=None, award=None)
$# :param Work work: The work that is being reviewed
$# :param str link_markup: arkup for element that triggers observations modal
$# :param str id: Unique identifier for this modal
$# :param str classes: HTML classes for this component
$# :param str reload_id: Reference to UI component that will update when observations are added or removed

$ topics = work.get_subjects()

$ username = ctx.user and ctx.user.key.split('/')[-1]
$# The following data is accessed via JS:
$ context = {
  $ "username": username,
  $ "work": work.key,
  $ "id": id
  $ }

$if reload_id:
  $ context['reloadId'] = reload_id

$# show edition cover if edition, else if work cover for work
$ work_key = work.key
$ src = '/images/icons/avatar_book.png'

$if edition_key:
  $ edition_id = edition_key.split('/')[-1]
  $ src = "https://covers.openlibrary.org/b/id/{}-M.jpg".format(edition_id)
$elif work_key:
  $ work_id = work_key.split('/')[-1]
  $ src = "https://covers.openlibrary.org/w/id/{}-M.jpg".format(work_id)

$if any(work.get_authors()):
  $ author_names = ", ".join(a.get("name", "Name missing") for a in work.get_authors())

$ default_comment = award['comment'] if award else ""
$ default_topic = award['topic'] if award else ""

$# Render the subject input field
$jsdef render_subject_field_bestbook(name, data):
    <div class="input">
        $code:
            subject_str = data[-1] if len(data) else ""
            rows = len(subject_str) // 95 + 1
        <textarea name="topic" rows="$rows" placeholder="$default_topic" wrap="soft" tabindex="0"></textarea>
    </div>

$jsdef render_subject_autocomplete_item(item):
    <div class="ac_subject" title="$_('Select this subject')">
        <span class="name">$item.name</span>
    </div>

<div class="$classes">
  $:link_markup
  $if ctx.user:
    <div class="hidden">
      <div id="$id-metadata-form" class="metadata-form bestbook-modal" data-context="$json_encode(context)">
        <div class="floaterHead">
          <h2>$_("Best Book Award")</h2>
          <a class="dialog--close">&times;<span class="shift">$_("Close")</span></a>
        </div>
        <div class="bestbook_body">
          <div class="bestbook_data">
            <h3>$work.title</h3>
            <img src="$src" class="bestbook-img" alt="Cover of: $(work.title)">
            <p>$author_names</p>
          </div>
          <form id="ratingsForm" method="POST" action="$(work.key)/awards.json" vocab="http://schema.org/" typeof="Books" class="bestbook">
            <label for="topic">On what topic?</label>
            $ config = {'name': 'topic', 'facet': 'subject', 'data': []}
            <div class="csv-autocomplete--subjects" data-config="$dumps(config)">
                $:render_subject_field_bestbook(config['name'], config['data'])
            </div>

            <input type="hidden" value="true" name="redir">
            <input type="hidden" value="$edition_key" name="edition_key">

            <label for="comment">Why?</label>
            <input name="comment" placeholder="comment" type="text" value="$default_comment">
            <button class="bestbook__submit" type="submit">Submit</button>
          </form>
        </div>
        <div>
          <form action="$(work.key)/awards.json" method="POST">
            <input type="hidden" value="true" name="redir">
            <button class="cta-btn cta-btn--delete bestbook-remove-button" type="submit">Remove award</button>
          </form>
        </div>
      </div>
    </div>
</div>
