$def with(work, reader_observations, key, edition_key=None)

$if reader_observations['total_respondents']:
  $ total_reviews = reader_observations['total_respondents']
$else:
  $ total_reviews = 0

$ user_award = None
$ submitter = None

$if ctx.user:
  $ submitter = ctx.user.key.split('/')[-1]
  $ user_award = work.get_award_by_submitter(submitter)

$ users_work_read_status = get_patrons_work_read_status(submitter, work.key) if work and submitter else None

$ d = {}
$ awards = []
$ num_awards = len(work.get_awards())
$if num_awards > 0:
  $ awards = work.get_awards()
  $for award in awards:
    $if award.topic in d:
      $ d[award.topic] += 1
    $else:
      $ d[award.topic] = 1

$ rating_stats = work and work.get_rating_stats() or {}
$ stats_by_bookshelf = work and work.get_num_users_by_bookshelf() or {}
$ avg = rating_stats.get('avg_rating')
$ ratings_count = rating_stats.get('num_ratings', 0)
$ review_count_class = 'readers-stats__review-count--none' if ratings_count == 0 else ''

<a id="reader-observations" name="reader-observations" class="section-anchor"></a>

<div class="tab-section review-component" id="reviews-section">
  <div class="reviews-header">
    <h2 class="observation-title">$_('Community Reviews') ($total_reviews)</h2>
    <a class="observations-feedback" href="https://forms.gle/wEr1dw3tLQYrC7Rr6">$_("Feedback?")</a>
  </div>
  <li class="avg-ratings" onclick="location.href='#starRatingSection';" data-ol-link-track="StarRating|StatsComponentClick">
    $if avg:
      $ stats_decimal = (float(avg))-(int(avg))
      $:('<span class="readers-stats__star">‚òÖ</span>' * int(avg))
      $if (stats_decimal >= 0.5) and (stats_decimal < 1):
        $:('<span class="readers-stats__star--half">‚òÖ</span>')
      <span itemprop="ratingValue">$avg</span>

      (
      <span itemprop="reviewCount">$ratings_count</span> $ungettext("Rating", "Ratings", ratings_count, count=ratings_count)
      )
  </li>
  <div class="reviews-div">
    <h3 class="reviews-subtitle">$_('Reviews')</h3>
    $if total_reviews > 0:
      <div class="reviews">
      $for o in reader_observations['observations']:
        <span class="review__category">
        $ total_respondents = o['total_respondents_for_type']
          <span class="reviews__label" title="$o['description']">$o['label'] <span class="reviews__count">$total_respondents</span></span>
          $ total_responses = o['total_responses']
          $for v in o['values']:
            $ percentage = (v['count'] / total_responses) * 100
            <span class="reviews__pill">
              <span class="reviews__value">
                $v['value']
              </span>
              <span class="percentage">
                $int(percentage)%
              </span>
            </span>
        </span>
      </div>
    $else:
      <div class="no-stats-message">$_('No reviews have been submitted for this work.')</div>
    <div class="review-cta">
      $if ctx.user:
        $ link_text = _('+ Add your community review')
        $ link_markup = '<a href="javascript:;" class="observations-modal-link">%s</a>' % link_text
        $:macros.ObservationsModal(work, link_markup, 'stats', 'stats-link')
      $else:
        <a class="login-link" href="/account/login?redirect=$(key)#reader-observations">$_('+ Log in to add your community review')</a>
    </div>
  </div>

  $# awards section here

  <div class="awards-div">
    <h3 class="reviews-subtitle">$_('Awards') (üèÜ $:num_awards)</h3>
    $if len(d) > 0:
      <div class="awards">
      $for topic, count in d.items():
        $ chip_classes = "chip category-chip"
        $if user_award and user_award['topic'] == topic:
          $ chip_classes += " chip--selected"
        <span class="$chip_classes">üèÜ $:count  $:topic</span>
      </div>
    $else:
      <div class="no-stats-message">$_('No bestbook awards have been awarded for this work.')</div>
    <div class="review-cta">
      $if ctx.user:
        $if user_award:
          $ link_text = _('+ Update Bestbook Award')
          $ link_markup = '<a href="javascript:;" class="observations-modal-link">%s</a>' % link_text
          $:macros.BestbookModal(work, link_markup, '', 'stats-link', '', edition_key, user_award)
        $elif users_work_read_status == 3:
          $ link_text = _('+ Give Bestbook Award')
          $ link_markup = '<a href="javascript:;" class="observations-modal-link">%s</a>' % link_text
          $:macros.BestbookModal(work, link_markup, '', 'stats-link', '', edition_key, user_award)
        $elif users_work_read_status == 1 or users_work_read_status == 2:
          <div class="status-awardable">$_('Complete reading book to award bestbook')</div>
        $else:
          <div class="status-awardable">$_('You can award bestbook only if you have read the book')</div>
      $else:
        <a class="login-link" href="/account/login?redirect=$(key)#reader-observations">$_('+ Log in to award this book')</a>
    </div>
  </div>
</div>
